#!/usr/bin/env python3

import cbor
import sys
import json
from socketserver import StreamRequestHandler, TCPServer
import signal
from types import ModuleType
import importlib
from outils_exercices.voile import VoilePudique, ErreurVoilée
import outils_exercices.jacadi as jacadi
import traceback

class ServeurTentatives(StreamRequestHandler):

    def évalue(self, mod_etu):
        sys.modules['code_etu'] = mod_etu

        if not self.module_ens:
            self.module_ens = importlib.import_module('{{module}}')

        importlib.reload(self.module_ens)

        for (nom, test) in self.module_ens.__dict__.items():
            if nom.startswith("test_"):
                try:
                    with VoilePudique(ErreurVoilée):
                        test()
                except ErreurVoilée as e_voilée:
                        return {
                            "_valide": False,
                            "_messages": e_voilée.messages()
                        }
                except Exception as e:
                    return {
                        "_valide": False,
                        "_messages": ["Bug dans l'exerciseur"] + traceback.format_exc().splitlines()
                    }

        return {
            "_valide": True,
            "_messages": ["Tous les tests ont réussi, champion·ne!"],
        }

    def __init__(self, *args):
        self.module_ens = None
        super().__init__(*args)

    def résultat_erreur_load(self, e):
        return {
            "_valide": False,
            "_messages": ["Exception au chargement de votre code", type(e), str(e)],
        }


    def résultat_fonction_manquante(self, nom_fonction):
        return {
            "_valide": False,
            "_messages": ["Vous ne fournissez pas la fonction {} demandée".format(nom_fonction)]
        }
    
    def résultat_erreur_exec(self, e):
        return {
            "_valide": False,
            "_messages": ["Exception à l'exécution de votre code", repr(e)],
        }

    def charge_code_etu(self, code_etu):
        mod_etu = ModuleType('code_etu')
        sys.modules['code_etu'] = mod_etu
        exec(code_etu, mod_etu.__dict__)
        return mod_etu
        
    def traite(self, code_etu):
        try:
            print("chargement code étu")
            mod_etu = self.charge_code_etu(code_etu)
        except Exception as e:
            return self.résultat_erreur_load(e)

        try:
            return self.évalue(mod_etu)
        except jacadi.FonctionÉtuManquante as fm:
            return self.résultat_fonction_manquante(fm.nom_f)
        except Exception as e:
            return self.résultat_erreur_exec(e)

        print("code étudiant étudié")
        
        print("résultat:", résultat)


    def ajoute_html(self, réponse):
        """
        Ajoute une version html à la réponse obtenue depuis `évalue`, dans
        son attribut "feedbacks_html".
        """
        feedback_html = "<div>\n"
        if réponse["_valide"]:
            feedback_html += "<p>Exercice réussi!</p>\n"
        else:
            feedback_html += "<p>Il y a une erreur</p>\n"
        if "_messages" in réponse and réponse["_messages"]:
            feedback_html += "<ul>\n"
            for ligne in réponse["_messages"]:
                feedback_html += "<li>" + ligne + "</li>\n"
            feedback_html += "</ul>\n"
        feedback_html += "</div>\n"
        réponse['feedbacks_html'] = feedback_html

    def handle(self):
        code_etu = cbor.load(self.rfile)
        print("reçu ceci: ", code_etu)
        résultat = self.traite(code_etu)
        self.ajoute_html(résultat)
        self.wfile.write(json.dumps(résultat).encode() + b'\n')
        self.wfile.flush()

def sigterm_handler(_signo, _stack_frame):
    exit(0)

if __name__ == "__main__":
    port = 5678 if len(sys.argv) < 2 else int(sys.argv[1])
    signal.signal(signal.SIGTERM, sigterm_handler)
    with TCPServer(("", port), ServeurTentatives) as serv:
        serv.serve_forever()

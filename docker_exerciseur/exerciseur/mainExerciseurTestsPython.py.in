#!/usr/bin/env python3

from http.server import BaseHTTPRequestHandler
from outils_exercices.voile import VoilePudique, ErreurVoilÃ©e
from types import ModuleType
import cbor
import importlib
import json
import outils_exercices.jacadi as jacadi
import random
import signal
import socketserver
import sys
import traceback

class ServeurTentatives(BaseHTTPRequestHandler):

    def Ã©value(self, mod_etu, code_etu, avec_ast=False):
        sys.modules['code_etu'] = mod_etu
        if not self.module_ens:
            self.module_ens = importlib.import_module('{{module}}')

        importlib.reload(self.module_ens)

        valide = True
        messages = []
        for (nom, test) in self.module_ens.__dict__.items():
            if nom.startswith("test_"):
                try:
                    with VoilePudique(ErreurVoilÃ©e):
                        retour_test = test()
                        if retour_test :
                            messages.append(retour_test)
                except ErreurVoilÃ©e as e_voilÃ©e:
                    valide = False
                    messages.append(e_voilÃ©e.messages())
                except Exception as e:
                    return {
                        "_valide": False,
                        "_messages": ["Bug dans l'exerciseur"] + traceback.format_exc().splitlines()
                    }
        if valide :
            messages.append("Tous les tests ont rÃ©ussi, championÂ·ne!")
        res = {
            "_valide": valide,
            "_messages": messages
            }
        if avec_ast:
            if "genere_aes" in self.module_ens.__dict__:
                t = self.module_ens.genere_aes(code_etu)
                print(t)
                res["AES"], res["AST"], res["traces"] =t
        return res

    def __init__(self, *args):
        self.module_ens = None
        super().__init__(*args)

    def rÃ©sultat_erreur_load(self, e, code_etu):
        return {
            "_valide": False,
            "_messages": ["Exception au chargement de votre code", str(type(e)), str(e), str(code_etu)],
        }


    def rÃ©sultat_fonction_manquante(self, nom_fonction):
        return {
            "_valide": False,
            "_messages": ["Vous ne fournissez pas la fonction {} demandÃ©e".format(nom_fonction)]
        }

    def rÃ©sultat_erreur_exec(self, e):
        return {
            "_valide": False,
            "_messages": ["Exception Ã  l'exÃ©cution de votre code", repr(e)],
        }

    def charge_code_etu(self, code_etu):
        mod_etu = ModuleType('code_etu')
        sys.modules['code_etu'] = mod_etu
        exec(code_etu, mod_etu.__dict__)
        return mod_etu

    def traite(self, code_etu, **kwargs):
        try:
            print("chargement code Ã©tu")
            mod_etu = self.charge_code_etu(code_etu)
        except Exception as e:
            return self.rÃ©sultat_erreur_load(e, code_etu)

        try:
            return self.Ã©value(mod_etu, code_etu, **kwargs)
        except jacadi.FonctionÃ‰tuManquante as fm:
            return self.rÃ©sultat_fonction_manquante(fm.nom_f)
        except Exception as e:
            return self.rÃ©sultat_erreur_exec(e)

        print("code Ã©tudiant Ã©tudiÃ©")

        print("rÃ©sultat:", rÃ©sultat)


    def ajoute_html(self, rÃ©ponse):
        """
        Ajoute une version html Ã  la rÃ©ponse obtenue depuis `Ã©value`, dans
        son attribut "feedbacks_html".
        """
        if(not isinstance(rÃ©ponse, dict)):
            rÃ©ponse = {"_erreur_ajoute_html": "rÃ©ponse is not a dict :" + str(rÃ©ponse)}
            return
        feedback_html = "<div>\n"
        if rÃ©ponse.get("_valide", False):
            emoji = random.choice("ğŸ‘ğŸ‘ğŸ’–ğŸ’¯ğŸ’ªğŸ“ˆğŸ—¸ğŸ˜€ğŸ˜ğŸ˜ƒğŸš€ğŸ¤“ğŸ¤¸ğŸ¥‡")
            feedback_html += "<p>" + emoji + " Exercice rÃ©ussi!</p>\n"
        else:
            feedback_html += "<p>Il y a une erreur</p>\n"
        if "_messages" in rÃ©ponse and rÃ©ponse["_messages"]:
            feedback_html += "<ul>\n"
            for message in rÃ©ponse["_messages"]:
                feedback_html += "<li>" + str(message) + "</li>\n"
            feedback_html += "</ul>\n"
        feedback_html += "</div>\n"
        rÃ©ponse['feedbacks_html'] = feedback_html

    def do_POST(self):
        mesg=b""
        while True:
            line = self.rfile.readline().strip()
            chunk_length = int(line, 16)
            if chunk_length != 0:
                    chunk = self.rfile.read(chunk_length)
                    mesg+=chunk
                    self.rfile.readline()
            else:
                break


        self.send_response(200)
        self.end_headers()
        dict_code_etu = cbor.loads(mesg)
        rÃ©sultat = self.traite(**dict_code_etu)
        self.ajoute_html(rÃ©sultat)

        self.wfile.write(json.dumps(rÃ©sultat).encode() + b'\n')
        self.wfile.flush()



def sigterm_handler(_signo, _stack_frame):
    exit(0)

if __name__ == "__main__":
    signal.signal(signal.SIGTERM, sigterm_handler)
    with socketserver.TCPServer(("", 8082), ServeurTentatives ) as httpd:
        httpd.serve_forever()
